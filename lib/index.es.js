import{Component as t,createElement as e,useState as o,useEffect as r}from"react";import*as i from"freezer-js";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])})(t,e)};function s(t,e){function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}var a,p=function(){return(p=Object.assign||function(t){for(var e,o=1,r=arguments.length;o<r;o++)for(var i in e=arguments[o])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},u=function(){function t(t,e){void 0===e&&(e=1/0),this.name=t,this.lifetime=e,this.persistence=!0,this.initialState=null}return t.prototype.pack=function(t){return{data:t,timestamp:Date.now()}},t.prototype.reset=function(){var t=this.pack(this.initialState);return this.write(t),t},Object.defineProperty(t.prototype,"storeName",{get:function(){return("store.persistent."+this.type+"."+this.name).toLowerCase()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dumpHistoryName",{get:function(){return("store.persistent.dump.history."+this.type+"."+this.name).toLowerCase()},enumerable:!0,configurable:!0}),t}(),h=function(t){function e(e,o){void 0===o&&(o=1/0);var r=t.call(this,e,o)||this;return r.name=e,r.lifetime=o,r.storage=null,r.type="localStorage","undefined"!=typeof window&&window.localStorage&&(r.storage=window.localStorage),r}return s(e,t),e.prototype.write=function(t){if(this.storage&&this.persistence)try{this.storage.setItem(this.storeName,JSON.stringify(t))}catch(t){console.error(t)}},e.prototype.read=function(){if(this.storage&&this.persistence){var t=null;try{t=JSON.parse(this.storage.getItem(this.storeName)),Boolean(t)||Boolean(t.timestamp)||(t=this.reset())}catch(e){t=this.reset()}return t}return this.reset()},e.prototype.saveDump=function(t){var e=t.timestamp;if(this.storage&&this.persistence)try{var o=JSON.parse(this.storage.getItem(this.dumpHistoryName));o&&o.dumpHistory?(o.dumpHistory.push(t),this.storage.setItem(this.dumpHistoryName,JSON.stringify(o))):this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[t]}))}catch(o){try{this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[t]}))}catch(t){console.error(t),e=null}console.error(o),e=null}return e},e.prototype.removeDump=function(t){if(this.storage&&this.persistence)try{var e=JSON.parse(this.storage.getItem(this.dumpHistoryName));if(e&&e.dumpHistory){var o=e.dumpHistory.filter(function(e){return e.timestamp!==t});this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:o}))}}catch(t){console.error(t)}},e.prototype.readDump=function(t){var e=null;if(this.storage&&this.persistence)try{var o=JSON.parse(this.storage.getItem(this.dumpHistoryName));e=o&&o.dumpHistory?o.dumpHistory.find(function(e){return e.timestamp===t}):null}catch(t){console.error(t)}return e},e.prototype.getDumpHistory=function(){var t=[];if(this.storage&&this.persistence)try{t=JSON.parse(this.storage.getItem(this.dumpHistoryName)).dumpHistory.map(function(t){return t.timestamp})}catch(e){console.error(e),t=[]}return t},e.prototype.resetHistory=function(){if(this.storage&&this.persistence)try{this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[]}))}catch(t){console.error(t)}},e}(u),c=function(t){function e(e,o){var r=t.call(this,e)||this;for(var i in r.stores={},r.isStoreMounted=!1,r.stores=o,r.stores){if(r.stores.hasOwnProperty(i))r.stores[i].components.push(r)}return r}return s(e,t),e.prototype.storeComponentDidMount=function(){},e.prototype.storeComponentWillUnmount=function(){},e.prototype.storeComponentWillReceiveProps=function(t){},e.prototype.storeComponentWillUpdate=function(t,e){},e.prototype.storeComponentDidUpdate=function(t,e){},e.prototype.shouldStoreComponentUpdate=function(t,e){return!0},e.prototype.storeComponentStoreWillUpdate=function(){},e.prototype.storeComponentStoreDidUpdate=function(){},e.prototype.componentDidMount=function(){this.isStoreMounted=!0,this.storeComponentDidMount()},e.prototype.componentWillUnmount=function(){var t=this;if(this.storeComponentWillUnmount(),this.stores){var e=function(e){if(o.stores.hasOwnProperty(e)){var r=o.stores[e],i=[];r.components.forEach(function(e){e!==t&&i.push(e)}),r.components=i}},o=this;for(var r in this.stores)e(r)}this.stores=null,this.isStoreMounted=!1},e.prototype.componentWillReceiveProps=function(t){this.storeComponentWillReceiveProps(t)},e.prototype.componentWillUpdate=function(t,e){this.storeComponentWillUpdate(t,e)},e.prototype.componentDidUpdate=function(t,e){this.storeComponentDidUpdate(t,e)},e.prototype.shouldComponentUpdate=function(t,e){return this.shouldStoreComponentUpdate(t,e)},e}(t),f=function(){function t(t,e,o){var r=this;this.persistenceDriver=o,this.components=[],this.eventManager=null,this.frozenState=null,this.initialState=null,this.opts={live:!1,freezeInstances:!1,mutable:!1,persistence:!1,setStateTimeout:0};var n=null;this.id=this.generateStoreName(t),e&&(this.opts.persistence=!0===e.persistence,this.opts.live=!0===e.live,this.opts.freezeInstances=!0===e.freezeInstances,this.opts.mutable=!0===e.mutable,this.opts.singleParent=!0,this.opts.setStateTimeout=e.setStateTimeout),this.persistenceDriver||(this.persistenceDriver=new h(this.id)),this.persistenceDriver.persistence=this.opts.persistence,this.persistenceDriver.initialState=t;var s=this.persistenceDriver.read().data;s&&(n=s),null===n&&(n=t),this.eventManager=new l(this.opts.setStateTimeout),this.initialState=new i({state:t}),this.frozenState=new i({state:n},this.opts),this.frozenState.on("update",function(t,e){r.update(t.state,e.state),r.persistenceDriver.write(r.persistenceDriver.pack(t.state))})}return Object.defineProperty(t.prototype,"state",{get:function(){return this.frozenState.get().state},enumerable:!0,configurable:!0}),t.prototype.hashCode=function(t){for(var e=0,o=0;e<t.length;e++)o=Math.imul(31,o)+t.charCodeAt(e)|0;return o.toString(16)},t.prototype.generateStoreName=function(t){var e="";for(var o in t)e+=o;return this.hashCode(e)},t.prototype.resetPersistence=function(){this.persistenceDriver.reset()},t.prototype.resetDumpHistory=function(){this.persistenceDriver.resetHistory(),this.eventManager.fire(a.DumpUpdate,this.frozenState.get().state,this.frozenState.get().state)},t.prototype.saveDump=function(){var t=this.persistenceDriver.saveDump(this.persistenceDriver.pack(this.frozenState.get().state));return this.eventManager.fire(a.DumpUpdate,this.frozenState.get().state,this.frozenState.get().state),t},t.prototype.removeDump=function(t){this.persistenceDriver.removeDump(t),this.eventManager.fire(a.DumpUpdate,this.frozenState.get().state,this.frozenState.get().state)},t.prototype.restoreDump=function(t){var e=this.persistenceDriver.readDump(t);e&&(this.setState(e.data),this.eventManager.fire(a.DumpUpdate,this.frozenState.get().state,this.frozenState.get().state))},t.prototype.getDumpHistory=function(){return this.persistenceDriver.getDumpHistory()},t.prototype.setState=function(t){var e=new i(t),o=p({},this.frozenState.get().state);for(var r in t){var n=e.get()[r];n!==o[r]&&(o[r]=n)}this.frozenState.get().state.set(o)},t.prototype.resetState=function(){this.setState(this.initialState.get().state)},t.prototype.update=function(t,e){this.components.forEach(function(t){t.isStoreMounted&&(t.storeComponentStoreWillUpdate(),t.forceUpdate(),t.storeComponentStoreDidUpdate())}),this.eventManager.fire(a.Update,t,e)},t.prototype.getInitialState=function(){return this.initialState.get().state},t.prototype.on=function(t,e){var o=t&&t.constructor===Array?t:[t],r=this.eventManager.add(o,e);return this.eventManager.fire(a.Init,this.frozenState.get().state,this.frozenState.get().state,r),this.eventManager.fire(a.DumpUpdate,this.frozenState.get().state,this.frozenState.get().state,r),r},t}();!function(t){t[t.All=0]="All",t[t.Init=1]="Init",t[t.Update=2]="Update",t[t.DumpUpdate=3]="DumpUpdate"}(a||(a={}));var m=function(){function t(t,e,o,r){this.id=t,this.types=e,this.onFire=o,this.onRemove=r,this.timeout=null}return t.prototype.remove=function(){this.timeout&&clearTimeout(this.timeout),this.onRemove(this.id)},t}(),l=function(){function t(t){this.fireTimeout=t,this.events=[],this.eventCounter=0,this.timeout=null}return t.prototype.generateEventId=function(){return""+ ++this.eventCounter+Date.now()+Math.random()},t.prototype.fire=function(t,e,o,r){var i=this;r?this.fireTimeout&&0!==this.fireTimeout?(r.timeout&&clearTimeout(this.timeout),r.timeout=setTimeout(function(){i.doFire(t,e,o,r)},this.fireTimeout)):this.doFire(t,e,o,r):this.fireTimeout&&0!==this.fireTimeout?(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){i.events.forEach(function(r){i.doFire(t,e,o,r)})},this.fireTimeout)):this.events.forEach(function(r){i.doFire(t,e,o,r)})},t.prototype.remove=function(t){var e=this;this.fireTimeout&&0!==this.fireTimeout&&this.events.forEach(function(t){t.timeout&&clearTimeout(e.timeout)}),this.events=this.events.filter(function(e){return e.id!==t})},t.prototype.add=function(t,e){var o=this,r=new m(this.generateEventId(),t,e,function(t){o.remove(t)});return this.events.push(r),r},t.prototype.doFire=function(t,e,o,r){(r.types.indexOf(t)>=0||r.types.indexOf(a.All)>=0)&&r.onFire(e,o,t)},t}(),y=function(o){return function(r){return function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.storeEvent=null,e.state={storeState:null},e}return s(i,t),i.prototype.componentWillMount=function(){var t=this;this.storeEvent=o.on(a.All,function(e,o,r){t.forceUpdate()})},i.prototype.componentWillUnmount=function(){this.storeEvent.remove()},i.prototype.render=function(){return e(r,this.props)},i}(t)}};function d(t,e){void 0===e&&(e={});var i=o(e.mapState?e.mapState(t.state):t.state),n=i[0],s=i[1];return r(function(){var o=t.on(e.eventType||a.Update,function(t){s(e.mapState?e.mapState(t):t)});return function(){o.remove()}},[]),n}export{f as Store,c as StoreComponent,m as StoreEvent,a as StoreEventType,u as StorePersistentDriver,h as StorePersistentLocalStorageDriver,y as followStore,d as useStore};
