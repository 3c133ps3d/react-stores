import{createElement as t,Component as e,useCallback as i,useState as r,useEffect as o}from"react";var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function s(t,e){function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var a,p=function(){return(p=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};!function(t){t[t.All=0]="All",t[t.Init=1]="Init",t[t.Update=2]="Update",t[t.DumpUpdate=3]="DumpUpdate"}(a||(a={}));var u=function(){function t(t,e,i,r){this.id=t,this.types=e,this.onFire=i,this.onRemove=r,this.timeout=null}return t.prototype.remove=function(){this.timeout&&clearTimeout(this.timeout),this.onRemove(this.id)},t}(),h=function(i){return function(r){return function(e){function o(){var t=null!==e&&e.apply(this,arguments)||this;return t.storeEvent=null,t.state={storeState:null},t}return s(o,e),o.prototype.componentWillMount=function(){var t=this;this.storeEvent=i.on(a.All,(function(){t.forceUpdate()}))},o.prototype.componentWillUnmount=function(){this.storeEvent.remove()},o.prototype.render=function(){return t(r,this.props)},o}(e)}},c=function(){function t(t,e){void 0===e&&(e=1/0),this.name=t,this.lifetime=e,this.persistence=!0,this.initialState=null}return t.prototype.pack=function(t){return{data:t,timestamp:Date.now()}},t.prototype.reset=function(){var t=this.pack(this.initialState);return this.write(t),t},Object.defineProperty(t.prototype,"storeName",{get:function(){return("store.persistent."+this.type+"."+this.name).toLowerCase()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dumpHistoryName",{get:function(){return("store.persistent.dump.history."+this.type+"."+this.name).toLowerCase()},enumerable:!0,configurable:!0}),t}(),m=function(t){function e(e,i){void 0===i&&(i=1/0);var r=t.call(this,e,i)||this;return r.name=e,r.lifetime=i,r.storage=null,r.type="localStorage","undefined"!=typeof window&&window.localStorage&&(r.storage=window.localStorage),r}return s(e,t),e.prototype.write=function(t){if(this.storage&&this.persistence)try{this.storage.setItem(this.storeName,JSON.stringify(t))}catch(t){console.error(t)}},e.prototype.read=function(){if(this.storage&&this.persistence){var t=null;try{t=JSON.parse(this.storage.getItem(this.storeName)),Boolean(t)||Boolean(t.timestamp)||(t=this.reset())}catch(e){t=this.reset()}return t}return this.reset()},e.prototype.saveDump=function(t){var e=t.timestamp;if(this.storage&&this.persistence)try{var i=JSON.parse(this.storage.getItem(this.dumpHistoryName));i&&i.dumpHistory?(i.dumpHistory.push(t),this.storage.setItem(this.dumpHistoryName,JSON.stringify(i))):this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[t]}))}catch(i){try{this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[t]}))}catch(t){console.error(t),e=null}console.error(i),e=null}return e},e.prototype.removeDump=function(t){if(this.storage&&this.persistence)try{var e=JSON.parse(this.storage.getItem(this.dumpHistoryName));if(e&&e.dumpHistory){var i=e.dumpHistory.filter((function(e){return e.timestamp!==t}));this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:i}))}}catch(t){console.error(t)}},e.prototype.readDump=function(t){var e=null;if(this.storage&&this.persistence)try{var i=JSON.parse(this.storage.getItem(this.dumpHistoryName));e=i&&i.dumpHistory?i.dumpHistory.find((function(e){return e.timestamp===t})):null}catch(t){console.error(t)}return e},e.prototype.getDumpHistory=function(){var t=[];if(this.storage&&this.persistence)try{var e=JSON.parse(this.storage.getItem(this.dumpHistoryName));e&&e.dumpHistory&&(t=e.dumpHistory.map((function(t){return t.timestamp})))}catch(e){console.error(e),t=[]}return t},e.prototype.resetHistory=function(){if(this.storage&&this.persistence)try{this.storage.setItem(this.dumpHistoryName,JSON.stringify({dumpHistory:[]}))}catch(t){console.error(t)}},e}(c),f=function(){function t(t){this.fireTimeout=t,this.events=[],this.eventCounter=0,this.timeout=null}return t.prototype.generateEventId=function(){return""+ ++this.eventCounter+Date.now()+Math.random()},t.prototype.fire=function(t,e,i,r){var o=this;if(r)this.fireTimeout&&0!==this.fireTimeout?(r.timeout&&clearTimeout(this.timeout),r.timeout=setTimeout((function(){o.doFire(t,e,i,r)}),this.fireTimeout)):this.doFire(t,e,i,r);else if(this.fireTimeout&&0!==this.fireTimeout)this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((function(){for(var r in o.events)o.doFire(t,e,i,o.events[r])}),this.fireTimeout);else for(var n in this.events)this.doFire(t,e,i,this.events[n])},t.prototype.remove=function(t){if(this.fireTimeout&&0!==this.fireTimeout)for(var e in this.events)this.events[e].timeout&&clearTimeout(this.timeout);this.events=this.events.filter((function(e){return e.id!==t}))},t.prototype.add=function(t,e){var i=this,r=new u(this.generateEventId(),t,e,(function(t){i.remove(t)}));return this.events.push(r),r},t.prototype.doFire=function(t,e,i,r){(r.types.indexOf(t)>=0||r.types.indexOf(a.All)>=0)&&r.onFire(e,i,t)},t}(),l=function(){function t(t,e,i){this.persistenceDriver=i,this.components=[],this.eventManager=null,this.initialState=null,this.frozenState=null,this.opts={live:!1,freezeInstances:!1,immutable:!1,persistence:!1,setStateTimeout:0};var r=null;if(this.id=this.generateStoreId(t),e&&(this.opts.immutable=!0===e.immutable,this.opts.persistence=!0===e.persistence,this.opts.setStateTimeout=e.setStateTimeout),this.persistenceDriver||(this.persistenceDriver=new m(this.id)),this.opts.persistence){var o=this.persistenceDriver.read().data;o&&(r=o)}null===r&&(r=t),this.persistenceDriver.persistence=this.opts.persistence,this.persistenceDriver.initialState=t,this.eventManager=new f(this.opts.setStateTimeout),this.initialState=this.deepFreeze(t),this.frozenState=this.deepFreeze(r)}return Object.defineProperty(t.prototype,"state",{get:function(){return this.frozenState},enumerable:!0,configurable:!0}),t.prototype.deepFreeze=function(t){if(this.opts.immutable){var e=Object.getOwnPropertyNames(t);for(var i in e){var r=t[e[i]];"object"==typeof r&&null!==r&&this.deepFreeze(r)}return Object.freeze(t)}return t},t.prototype.hashCode=function(t){for(var e=0,i=0;i<t.length;i++)e=Math.imul(31,e)+t.charCodeAt(i)|0;return e.toString(16)},t.prototype.generateStoreId=function(t){var e="";for(var i in t)e+=i;return this.hashCode(e)},t.prototype.resetPersistence=function(){this.persistenceDriver.reset()},t.prototype.resetDumpHistory=function(){this.persistenceDriver.resetHistory(),this.eventManager.fire(a.DumpUpdate,this.frozenState,this.frozenState)},t.prototype.saveDump=function(){var t=this.persistenceDriver.saveDump(this.persistenceDriver.pack(this.frozenState));return this.eventManager.fire(a.DumpUpdate,this.frozenState,this.frozenState),t},t.prototype.removeDump=function(t){this.persistenceDriver.removeDump(t),this.eventManager.fire(a.DumpUpdate,this.frozenState,this.frozenState)},t.prototype.restoreDump=function(t){var e=this.persistenceDriver.readDump(t);if(e){var i=this.deepFreeze(this.frozenState);this.setState(e.data),this.eventManager.fire(a.DumpUpdate,this.frozenState,i)}},t.prototype.getDumpHistory=function(){return this.persistenceDriver.getDumpHistory()},t.prototype.setState=function(t){var e=this.deepFreeze(this.frozenState),i=this.deepFreeze(p(p({},e),t));this.update(i,e),this.persistenceDriver.write(this.persistenceDriver.pack(i)),this.frozenState=i},t.prototype.resetState=function(){this.setState(this.deepFreeze(this.initialState))},t.prototype.update=function(t,e){for(var i in this.components)this.components[i].isStoreMounted&&(this.components[i].storeComponentStoreWillUpdate(),this.components[i].forceUpdate(),this.components[i].storeComponentStoreDidUpdate());for(var i in this.components)this.components[i].isStoreMounted&&(this.components[i].storeComponentStoreWillUpdate(),this.components[i].forceUpdate(),this.components[i].storeComponentStoreDidUpdate());this.eventManager.fire(a.Update,t,e)},t.prototype.getInitialState=function(){return this.initialState},t.prototype.on=function(t,e){var i=t&&t.constructor===Array?t:[t],r=this.eventManager.add(i,e);return this.eventManager.fire(a.Init,this.frozenState,this.frozenState,r),this.eventManager.fire(a.DumpUpdate,this.frozenState,this.frozenState,r),r},t}();function y(t,e){void 0===e&&(e={});var n=e.deps||[],s=i((function(t){return e.mapState?e.mapState(t):t}),n),p=r(s(t.state)),u=p[0],h=p[1];return o((function(){var i=t.on(e.eventType||a.All,(function(t){h(s(t))}));return function(){i.remove()}}),[]),u}export{l as Store,u as StoreEvent,a as StoreEventType,c as StorePersistentDriver,m as StorePersistentLocalStorageDriver,h as followStore,y as useStore};
